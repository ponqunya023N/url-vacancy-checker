name: URL Vacancy Checker  # [001]
  # [002]
on:  # [003]
  workflow_dispatch:        # Cloudflare WorkersからのAPI呼び出し、または手動実行のみ  # [004]
#  schedule:                  # Cloudflare側で管理するため二重起動防止で停止  # [005]
#    - cron: '*/3 * * * *'  # [006]
  # [007]
permissions:  # [008]
  contents: write           # status.jsonを更新するために必須  # [009]
  # [010]
jobs:  # [011]
  vacancy-check:  # [012]
    runs-on: ubuntu-latest  # [013]
    concurrency:            # 【修正】同時に起動した場合、古い方をキャンセルせず、実行中の処理が終わるまで次を待機させる  # [014]
      group: vacancy-check  # [015]
#     cancel-in-progress: true  # [016] （元のコード：古い方をキャンセルする設定）
      cancel-in-progress: false  # [017] （新しいコード：実行中の処理が終わるまで待機させる設定）
  # [018]
    steps:  # [019]
      - name: Checkout repository  # [020]
        uses: actions/checkout@v4  # [021]
        with:  # [022]
          fetch-depth: 0  # [023]
          persist-credentials: true  # [024]
  # [025]
      - name: Set up Python  # [026]
        uses: actions/setup-python@v5  # [027]
        with:  # [028]
          python-version: '3.11'  # [029]
  # [030]
      - name: Install dependencies  # [031]
        run: |  # [032]
          python -m pip install --upgrade pip  # [033]
          pip install playwright==1.49.0  # [034]
  # [035]
      - name: Install browsers  # [036]
        run: playwright install --with-deps  # [037]
  # [038]
      - name: Run vacancy check  # [039]
        run: python check_vacancy.py  # [040]
        env:  # [041]
          # Telegram通知用のシークレットと、今回秘匿化したURL群を使用  # [042]
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  # [043]
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}  # [044]
          TARGET_URLS: ${{ secrets.TARGET_URLS }}  # [045]
          # 【追加】SecretsからベースURLを読み込む設定  # [046]
          BASE_URL: ${{ secrets.BASE_URL }}  # [047]
  # [048]
      - name: Commit status.json  # [049]
        run: |  # [050]
          git config --global user.name "github-actions"  # [051]
          git config --global user.email "github-actions@github.com"  # [052]
            # [053]
          # 1. 自分が書き換えたstatus.jsonをいったん退避  # [054]
          git stash  # [055]
            # [056]
          # 2. リモートの最新状態（別の実行による更新）を取り込む  # [057]
          git pull origin main --rebase  # [058]
            # [059]
          # 3. 退避した自分の変更を戻す（コンフリクト時は自分の変更を優先）  # [060]
          git stash pop || git checkout --ours status.json  # [061]
            # [062]
          git add status.json  # [063]
          git commit -m "Update status.json [skip ci]" || echo "No changes to commit"  # [064]
          git push origin main  # [065]
