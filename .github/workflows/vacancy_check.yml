name: UR Vacancy Checker

on:
  schedule:
    - cron: '0 * * * *' # 毎時0分に実行
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
    steps:
      - name: 📦 リポジトリのチェックアウト
        uses: actions/checkout@v4

      - name: 🐍 Pythonのセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 🌐 Google Chrome のインストール
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: 📦 依存関係のインストール
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🛠 UR空き情報チェック実行
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        run: |
          # Pythonスクリプトを実行して結果を一時ファイルに保存
          python check_vacancy.py > vacancy_result.txt || exit 1
          
          # 新規空き情報がある団地だけを出力
          echo "=== 新規空き情報が出た団地 ==="
          grep "空きあり" vacancy_result.txt || echo "なし"
          
          # ログが必要であれば全体を表示
          echo "=== 実行ログ（全体） ==="
          cat vacancy_result.txt
